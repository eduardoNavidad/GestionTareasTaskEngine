# Nombre del proceso que aparecer√° en la pesta√±a 'Actions' de GitHub
name: Deploy TaskEngine to Azure Linux

# Define cu√°ndo se dispara el proceso
on:
  push:
    branches:
      - master
      - Testing
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    # Usamos un servidor de GitHub con Ubuntu (Linux) para compilar
    runs-on: ubuntu-latest

    steps:
      # 1. Copia tu c√≥digo del repositorio al servidor de GitHub
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      # 2. Instala el SDK de .NET para poder compilar
      - name: Configurar .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # 3. Restaura las librer√≠as de NuGet
      - name: Restaurar dependencias
        run: dotnet restore

      # 4. Compila la soluci√≥n completa en modo 'Release'
      - name: Compilar
        run: dotnet build --no-restore --configuration Release

      # 5. EJECUTAR TESTS UNITARIOS üõ°Ô∏è
      # Usamos --no-build para usar lo que compilamos en el paso anterior
      - name: Ejecutar Tests
        run: dotnet test --no-build --configuration Release --verbosity normal

      # 6. Publicar SOLAMENTE el proyecto API
      - name: Publicar app
        run: dotnet publish TaskEngine.Api/TaskEngine.Api.csproj -c Release -o ./publish

      # 7. Desplegar a Azure Web App (CONDICIONAL) üöÄ
      # La l√≠nea 'if' asegura que SOLO si el cambio es en 'master' se suba a Azure.
      - name: Desplegar a Azure Web App
        if: github.ref == 'refs/heads/master'
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'api-eduardo-sv'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./publish